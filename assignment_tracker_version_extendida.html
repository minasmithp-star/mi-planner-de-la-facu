<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Assignment Tracker ‚Äî Pro</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#faf6fb; --card:#ffffff; --ink:#2b2036; --muted:#6d5f7a;
  --rose:#e8c6cf; --rose-deep:#d9a4b3; --border:#ead9ea; --shadow:0 10px 30px rgba(100,60,120,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);
  background:radial-gradient(900px 500px at -10% -10%, #f2e6f4, transparent),radial-gradient(900px 500px at 110% -10%, #f3eaf3, transparent),var(--bg)}
.header{padding:16px;display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap;border-bottom:1px solid var(--border);backdrop-filter: blur(6px);background:rgba(250,246,251,.75)}
.brand{display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap}
.title-card{background:var(--rose);border:1px solid var(--border);padding:14px 18px;border-radius:12px;font-weight:900;letter-spacing:.5px}
.today-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 14px}
.today-card .label{font-size:.85rem;color:var(--muted);font-weight:800}
.today-card .date{font-weight:900}
.metrics{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
.metric{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 14px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:4px;min-width:160px}
.metric span{color:var(--muted);font-weight:700}
.metric strong{font-size:1.5rem}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{background:linear-gradient(180deg,var(--rose),var(--rose-deep));color:white;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
.btn-ghost{background:#fff;color:var(--muted);border:1px solid var(--border)}
.file-label{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
.container{max-width:1200px;margin:18px auto;padding:0 16px;display:grid;gap:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{background:#fff;border:1px solid var(--border);border-radius:999px;padding:8px 14px;font-weight:800;cursor:pointer}
.tab.active{background:linear-gradient(180deg,var(--rose),#fff)}
.panel{display:none}
.panel.active{display:block}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.card.chart.small .chartbox{height:160px}
.chartbox canvas{width:100% !important;height:100% !important}
/* Focus */
.focus-cols{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.focus-list{list-style:none;margin:0;padding:0;display:grid;gap:8px}
.focus-item{border:1px solid var(--border);border-radius:12px;padding:8px 10px;background:#fff;display:flex;align-items:center;justify-content:space-between;gap:8px}
.focus-main{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.focus-title{font-weight:800}
.chip{padding:3px 8px;border-radius:999px;background:#f7eaf5;border:1px solid var(--border);font-weight:700;color:#6b3b59}
.mini-btn{background:#fff;border:1px solid var(--border);border-radius:10px;padding:4px 8px;cursor:pointer;font-weight:800;color:#6b3b59}
.mini-btn:hover{background:#f8f3f7}
/* Controls */
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.input, select{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;min-height:40px}
.quick-add{flex:1;min-width:240px}
/* Table */
.table-wrap{overflow:auto}
.table{width:100%;border-collapse:separate;border-spacing:0;min-width:1100px}
.table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle}
.table thead th{background:#f4ecf4;border-bottom:2px solid var(--border)}
.badge{padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-weight:800}
.badge.status{border:none}
/* Estados pastel */
.status.not {background:#ffdbe6; color:#6e2a41}
.status.prog{background:#ffe7cc; color:#6e4a12}
.status.sub {background:#ffe0f0; color:#6e2a50}
.status.grad{background:#efe6ff; color:#4b2b74}
.status.done{background:#e6f5ee; color:#1b5d41}
/* Prioridad pastel */
.priority.high{background:#ffd6d9;color:#7a1f1f;border-color:#ffd6d9}
.priority.med {background:#ffebc7;color:#7a4b14;border-color:#ffebc7}
.priority.low {background:#d9f7e8;color:#145a36;border-color:#d9f7e8}
/* Row bg by priority */
tr.row-high {background:#fff4f5}
tr.row-med  {background:#fff8ec}
tr.row-low  {background:#f4fbf7}
.selected-row{outline:2px solid #d9a4b3}
/* Thermometer */
.thermo{position:relative;width:90px;height:16px;border-radius:999px;background:#f3eef3;border:1px solid var(--border);overflow:hidden}
.thermo-bar{position:absolute;left:0;top:0;bottom:0;border-radius:999px}
.thermo-label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.8rem;color:#5c4f65;font-weight:800}
/* Kanban */
.kanban{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
.col{background:#fff;border:1px solid var(--border);border-radius:12px;min-height:240px;display:flex;flex-direction:column}
.col h4{margin:8px 8px 0 8px}
.klist{padding:8px;display:grid;gap:8px;min-height:200px}
.cardk{background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px;cursor:grab}
.cardk .title{font-weight:800}
.cardk .meta{color:#6b3b59;font-size:.85rem}
/* Analysis */
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.heat{display:grid;grid-template-columns:repeat(14,1fr);gap:4px}
.heat div{height:20px;border-radius:6px;background:#f1e6f0;border:1px solid var(--border)}
/* Modal */
.modal{border:none;border-radius:18px;padding:0}
.modal-box{min-width:320px;max-width:780px;border:none;padding:0}
.modal .form{display:grid;gap:10px;padding:16px}
.modal .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.modal .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.modal .actions{display:flex;justify-content:flex-end;gap:8px;border-top:1px solid var(--border);padding:12px 16px;background:#fff}
/* Subtasks */
.sublist{display:grid;gap:6px}
.subrow{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:8px;background:#faf7fb;border:1px dashed var(--border);border-radius:10px;padding:6px}
.subrow input[type="text"]{border:1px solid var(--border);border-radius:8px;padding:6px 8px}
/* Footer */
.footer{padding:24px 16px;text-align:center;color:var(--muted)}
@media (max-width:900px){.grid-2{grid-template-columns:1fr}.focus-cols{grid-template-columns:1fr}.kanban{grid-template-columns:1fr}}
</style>
</head>
<body>
<header class="header">
  <div class="brand">
    <div class="title-card">ASSIGNMENT TRACKER</div>
    <div class="today-card">
      <div class="label">FECHA DE HOY</div>
      <div id="todayStr" class="date">‚Äî</div>
    </div>
  </div>
  <div class="metrics">
    <div class="metric"><span>Total de tareas</span><strong id="totalCount">0</strong></div>
    <div class="metric"><span>Tareas completadas</span><strong id="doneCount">0</strong></div>
    <div class="actions">
      <label class="btn file-label">Importar JSON<input id="importInput" type="file" accept="application/json" hidden/></label>
      <button id="exportBtn" class="btn">Exportar JSON</button>
      <label class="btn file-label">Importar CSV<input id="importCSV" type="file" accept="text/csv" hidden/></label>
      <button id="exportCSV" class="btn btn-ghost">Exportar CSV</button>
      <button id="resetBtn" class="btn btn-ghost">Reiniciar</button>
      <button id="addAssignBtn" class="btn">A√±adir tarea</button>
      <button id="manageCoursesBtn" class="btn btn-ghost">Cursos</button>
    </div>
  </div>
</header>

<main class="container">
  <nav class="tabs">
    <button class="tab active" data-tab="tabla">Tabla</button>
    <button class="tab" data-tab="kanban">Kanban</button>
    <button class="tab" data-tab="analitica">An√°lisis</button>
    <button class="tab" data-tab="plan">Plan semanal</button>
  </nav>

  <!-- Charts small -->
  <section class="grid-2 panel active" id="p-tabla-0">
    <div class="card chart small"><h3>Estados de las tareas</h3><div class="chartbox"><canvas id="pieStatus"></canvas></div></div>
    <div class="card chart small"><h3>Distribuci√≥n de notas (1‚Äì10)</h3><div class="chartbox"><canvas id="barGrades"></canvas></div></div>
  </section>

  <!-- Focus Panel -->
  <section class="card panel active" id="p-tabla-1">
    <div class="focus-cols">
      <div><h3>Atrasadas</h3><ul id="listOverdue" class="focus-list"></ul></div>
      <div><h3>Hoy</h3><ul id="listToday" class="focus-list"></ul></div>
      <div><h3>Pr√≥ximos 7 d√≠as</h3><ul id="listWeek" class="focus-list"></ul></div>
    </div>
  </section>

  <!-- Controls -->
  <section class="card panel active" id="p-tabla-2">
    <div class="controls">
      <input id="quickAdd" class="input quick-add" placeholder="A√±adir r√°pido: Curso ¬∑ T√≠tulo ¬∑ dd/mm [#tag] [3h]" />
      <input id="searchInput" class="input" placeholder="Buscar‚Ä¶ (usa #etiqueta)" />
      <select id="filterCourse" class="input"></select>
      <select id="filterStatus" class="input">
        <option value="all">Todos los estados</option>
        <option>No iniciado</option><option>En progreso</option><option>Entregado</option><option>Calificado</option><option>Completado</option>
      </select>
      <select id="filterPriority" class="input"><option value="all">Todas las prioridades</option><option>Alta</option><option>Media</option><option>Baja</option></select>
      <button id="bulkIcs" class="btn btn-ghost">Seleccionados ‚Üí .ics</button>
      <button id="bulkDone" class="btn btn-ghost">Seleccionados ‚Üí ‚úî</button>
    </div>
    <datalist id="taglist"></datalist>
  </section>

  <!-- Table -->
  <section class="card panel active" id="p-tabla-3">
    <div class="table-wrap">
      <table class="table" id="table">
        <thead><tr>
          <th style="width:30px"><input type="checkbox" id="checkAll"/></th>
          <th>Tarea</th><th>Curso</th><th>Estado</th><th>Fecha l√≠mite</th><th>D√≠as</th><th>Prioridad</th>
          <th>Tipo</th><th>Tiempo est.</th><th>Etiquetas</th><th>Notas</th><th>Calificaci√≥n</th><th>Acciones</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- Kanban -->
  <section class="card panel" id="p-kanban">
    <div class="kanban" id="kanban"></div>
  </section>

  <!-- Analytics -->
  <section class="panel" id="p-analitica">
    <div class="grid-3">
      <div class="card"><h3>Creadas vs Completadas (semanas)</h3><div class="chartbox" style="height:220px"><canvas id="chActivity"></canvas></div></div>
      <div class="card"><h3>Horas por curso (√∫ltimos 7 d√≠as)</h3><div class="chartbox" style="height:220px"><canvas id="chHours"></canvas></div></div>
      <div class="card"><h3>Pr√≥ximos 14 d√≠as (calor)</h3><div class="heat" id="heat"></div></div>
    </div>
  </section>

  <!-- Plan semanal -->
  <section class="card panel" id="p-plan">
    <h3>Plan semanal autom√°tico</h3>
    <p>Genera bloques de estudio a partir del <strong>Tiempo estimado</strong> de cada tarea pr√≥xima.</p>
    <div class="controls">
      <label>D√≠as: <input id="planDays" class="input" value="Lun,Mar,Mi√©,Jue,Vie"/></label>
      <label>Horario: <input id="planHours" class="input" value="18:00-20:00"/></label>
      <label>Bloque (min): <input id="planBlock" type="number" class="input" value="90"/></label>
      <button id="genPlan" class="btn">Generar plan</button>
      <button id="dlPlanIcs" class="btn btn-ghost">Descargar .ics</button>
    </div>
    <div id="planList" style="margin-top:10px"></div>
  </section>
</main>

<dialog id="modal" class="modal"><form method="dialog" class="modal-box" id="modalContent"></form></dialog>
<footer class="footer"><small>Assignment Tracker ‚Äî versi√≥n extendida üíó</small></footer>

<script>
// ===== Utils =====
const $=(s,el=document)=>el.querySelector(s), $$=(s,el=document)=>Array.from(el.querySelectorAll(s));
const uid=()=>Math.random().toString(36).slice(2,10);
const STORAGE_KEY='assignment_tracker_pro_v1';
const save=()=>localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
const load=()=>{try{return JSON.parse(localStorage.getItem(STORAGE_KEY));}catch{return null}};
const todayISO=()=>new Date().toISOString().slice(0,10);
const fmtToday4Y=iso=>{const d=new Date(iso+'T00:00:00');return d.toLocaleDateString('es',{weekday:'long',day:'2-digit',month:'long',year:'numeric'})};
const fmtShort2Y=iso=>{if(!iso) return '‚Äî'; const d=new Date(iso+'T00:00:00'); return d.toLocaleDateString('es',{day:'2-digit',month:'2-digit',year:'2-digit'});};
const daysLeft=iso=>{if(!iso) return null; const t=new Date(); t.setHours(0,0,0,0); const d=new Date(iso+'T00:00:00'); return Math.round((d-t)/86400000)};
const parseEst=(s)=>{if(!s) return 0; const m=String(s).trim(); let mins=0; const rH=m.match(/(\d+(?:\.\d+)?)\s*h/); if(rH) mins+=parseFloat(rH[1])*60; const rM=m.match(/(\d+)\s*m/); if(rM) mins+=parseInt(rM[1]); if(!rH && !rM && /^\d+$/.test(m)) mins=parseInt(m); return Math.round(mins)};
const clamp=(n,min,max)=>Math.min(max,Math.max(min,n));
const esc=s=>(s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

// Paletas
const pinks10=(()=>{const arr=[];for(let i=1;i<=10;i++){const t=(i-1)/9;const L=92 - t*40;arr.push(`hsl(340,85%,${L}%)`);}return arr})();
const statusPinks={"No iniciado":"hsl(340,85%,90%)","En progreso":"hsl(340,80%,83%)","Entregado":"hsl(340,75%,76%)","Calificado":"hsl(340,70%,69%)","Completado":"hsl(340,65%,62%)"};

// ===== Default data and state =====
const DEFAULT_COURSES=['Historia 101','√Ålgebra','Qu√≠mica','Ingl√©s'];
const DEFAULT_TYPES=['Ensayo','Tarea','Presentaci√≥n','Proyecto','Examen','Laboratorio'];
const DEFAULT_STATUS=['No iniciado','En progreso','Entregado','Calificado','Completado'];
const DEFAULT_PRIOS=['Alta','Media','Baja'];
let state=load() || { courses:[...DEFAULT_COURSES], assignments:[], tags:[], goals:{}, timers:{}, activity:[] };

// ===== Tabs =====
document.addEventListener('DOMContentLoaded',()=>{
  $('#todayStr').textContent = fmtToday4Y(todayISO()); // a√±o completo 2025
  $$('.tab').forEach(btn=>btn.addEventListener('click',()=>{
    $$('.tab').forEach(b=>b.classList.remove('active'));
    $$('.panel').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    const id=btn.dataset.tab; // 'tabla'|'kanban'|'analitica'|'plan'
    if(id==='tabla'){ $('#p-tabla-0').classList.add('active'); $('#p-tabla-1').classList.add('active'); $('#p-tabla-2').classList.add('active'); $('#p-tabla-3').classList.add('active'); }
    else { ['#p-tabla-0','#p-tabla-1','#p-tabla-2','#p-tabla-3'].forEach(s=>$(s).classList.remove('active')); }
    if(id==='kanban') $('#p-kanban').classList.add('active');
    if(id==='analitica') $('#p-analitica').classList.add('active');
    if(id==='plan') $('#p-plan').classList.add('active');
    if(id==='analitica') renderAnalytics();
    if(id==='kanban') renderKanban();
  }));

  bindGlobal();
  renderAll();
});

function bindGlobal(){
  $('#addAssignBtn').addEventListener('click',()=>openAssignModal());
  $('#manageCoursesBtn').addEventListener('click', openCourseManager);
  $('#exportBtn').addEventListener('click', exportJSON);
  $('#importInput').addEventListener('change', importJSON);
  $('#exportCSV').addEventListener('click', exportCSV);
  $('#importCSV').addEventListener('change', importCSV);
  $('#resetBtn').addEventListener('click',()=>{ if(confirm('Esto borrar√° todos tus datos locales. ¬øContinuar?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); }});
  $('#searchInput').addEventListener('input', renderTable);
  $('#filterStatus').addEventListener('change', renderTable);
  $('#filterPriority').addEventListener('change', renderTable);
  $('#filterCourse').addEventListener('change', renderTable);
  $('#checkAll').addEventListener('change', (e)=>{ $$('#tbody input[type="checkbox"][data-row]') .forEach(ch=>{ ch.checked=e.target.checked; }); });
  $('#bulkIcs').addEventListener('click', bulkICS);
  $('#bulkDone').addEventListener('click', bulkDone);
  $('#quickAdd').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ quickAddFromInput(); }});

  // Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if(e.target.matches('input, textarea, select')) return;
    if(e.key.toLowerCase()==='/'){ e.preventDefault(); $('#searchInput').focus(); }
    else if(e.key.toLowerCase()==='n'){ e.preventDefault(); openAssignModal(); }
    else if(e.key.toLowerCase()==='e'){ e.preventDefault(); if(currentRowId) openAssignModal(findById(currentRowId)); }
    else if(e.key.toLowerCase()==='c'){ e.preventDefault(); if(currentRowId){ const a=findById(currentRowId); a.status='Completado'; save(); renderAll(); }}
  });

  // Plan semanal
  $('#genPlan').addEventListener('click', generatePlan);
  $('#dlPlanIcs').addEventListener('click', downloadPlanICS);
}

function renderAll(){
  renderFilters();
  renderTable();
  renderMetrics();
  renderCharts();
  renderFocusPanel();
  renderTagSuggestions();
}

function renderFilters(){
  const sel=$('#filterCourse');
  sel.innerHTML = `<option value="all">Todos los cursos</option>` + state.courses.map(c=>`<option>${esc(c)}</option>`).join('');
}

// ===== Table =====
let currentRowId=null;
function findById(id){ return state.assignments.find(a=>a.id===id); }

function renderTable(){
  const tbody=$('#tbody'); tbody.innerHTML='';
  const q=($('#searchInput').value||'').toLowerCase();
  const c=$('#filterCourse').value||'all';
  const s=$('#filterStatus').value||'all';
  const p=$('#filterPriority').value||'all';
  const hasTag=q.includes('#'); const qTag = hasTag ? q.split(/\s+/).find(w=>w.startsWith('#'))?.slice(1) : null;

  const items=state.assignments
    .filter(a=>c==='all' ? true : a.course===c)
    .filter(a=>s==='all' ? true : a.status===s)
    .filter(a=>p==='all' ? true : a.priority===p)
    .filter(a=>{
      const text=((a.title||'')+' '+(a.notes||'')+' '+(a.tags||[]).map(t=>'#'+t).join(' ')).toLowerCase();
      if(hasTag && qTag) return text.includes('#'+qTag);
      return text.includes(q);
    })
    .sort((a,b)=>{ const da=a.due?new Date(a.due):new Date('2999-01-01'); const db=b.due?new Date(b.due):new Date('2999-01-01'); return da-db; });

  items.forEach(a=>{
    const tr=document.createElement('tr');
    tr.dataset.id=a.id;
    if(a.priority==='Alta') tr.classList.add('row-high'); else if(a.priority==='Media') tr.classList.add('row-med'); else tr.classList.add('row-low');
    if(currentRowId===a.id) tr.classList.add('selected-row');
    const dleft=daysLeft(a.due);
    const subs=a.subs||[]; const done=subs.filter(x=>x.done).length; const subTxt=subs.length?` <span class="badge" title="Subtareas">‚úì${done}/${subs.length}</span>`:'';
    const tagPills=(a.tags||[]).map(t=>`<span class="badge">#${esc(t)}</span>`).join(' ');

    tr.innerHTML=`
      <td><input type="checkbox" data-row="${a.id}" ${a._checked?'checked':''}></td>
      <td>${esc(a.title)}</td>
      <td>${esc(a.course||'‚Äî')}</td>
      <td>${statusBadge(a.status)}</td>
      <td>${fmtShort2Y(a.due)}</td>
      <td>${daysThermo(dleft)}</td>
      <td>${prioBadge(a.priority)}</td>
      <td>${esc(a.type||'‚Äî')}</td>
      <td>${esc(a.est||'‚Äî')}</td>
      <td>${tagPills}</td>
      <td>${esc(a.notes||'')}${subTxt}</td>
      <td>${esc(a.grade||'')}</td>
      <td>
        <button class="mini-btn" data-timer="${a.id}">‚è±</button>
        <button class="mini-btn" data-ics="${a.id}">üìÖ</button>
        <button class="mini-btn" data-edit="${a.id}">‚úé</button>
        <button class="mini-btn" data-del="${a.id}">üóë</button>
      </td>`;
    $('#tbody').appendChild(tr);

    tr.addEventListener('click', (e)=>{ if(e.target.closest('button')||e.target.type==='checkbox') return; currentRowId=a.id; renderTable(); });

    tr.querySelector(`[data-ics="${a.id}"]`).addEventListener('click',()=>downloadICS(a));
    tr.querySelector(`[data-edit="${a.id}"]`).addEventListener('click',()=>openAssignModal(a));
    tr.querySelector(`[data-del="${a.id}"]`).addEventListener('click',()=>{ if(confirm('¬øEliminar tarea?')){ state.assignments=state.assignments.filter(x=>x.id!==a.id); save(); renderAll(); }});
    tr.querySelector(`[data-timer="${a.id}"]`).addEventListener('click',()=>openTimerModal(a));
    tr.querySelector(`[data-row]`).addEventListener('change',(e)=>{ a._checked=e.target.checked; });
  });

  if(!items.length){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="13" style="color:#777">No hay tareas.</td>'; tbody.appendChild(tr); }
}

function statusBadge(st){ const map={"No iniciado":"not","En progreso":"prog","Entregado":"sub","Calificado":"grad","Completado":"done"}; const key=map[st]||'not'; return `<span class="badge status ${key}">${st||'No iniciado'}</span>`; }
function prioBadge(p){ const key=p==='Alta'?'high':p==='Media'?'med':'low'; return `<span class="badge priority ${key}">${p||'‚Äî'}</span>`; }
function daysThermo(n){ if(n===null) return '‚Äî'; const horizon=21; const urg=Math.max(0,Math.min(1,1-(n/horizon))); const width=Math.round((n<0?1:urg)*100); const light=90-urg*28; const color=`hsl(350,75%,${light}%)`; const title=n<0?`${n} (atrasado)`:`${n} d√≠as`; return `<div class="thermo" title="${title}"><div class="thermo-bar" style="width:${width}%; background:${color}"></div><span class="thermo-label">${n}</span></div>`; }

// ===== Focus Panel =====
function renderFocusPanel(){
  const overdue=[], today=[], soon=[]; const now=new Date(); now.setHours(0,0,0,0);
  state.assignments.forEach(a=>{ if(a.status==='Completado') return; if(!a.due) return; const d=new Date(a.due+'T00:00:00'); const diff=Math.round((d-now)/86400000); if(diff<0) overdue.push(a); else if(diff===0) today.push(a); else if(diff>0 && diff<=7) soon.push(a); });
  const fill=(id,arr)=>{ const ul=$(id); ul.innerHTML=''; if(!arr.length){ ul.innerHTML='<li class="focus-item">Sin tareas</li>'; return; } arr.sort((a,b)=>new Date(a.due)-new Date(b.due)).slice(0,10).forEach(a=>{ const li=document.createElement('li'); li.className='focus-item'; li.innerHTML=`<div class="focus-main"><span class="focus-title">${esc(a.title)}</span><span class="chip">${esc(a.course||'General')}</span><span class="chip">vence: ${fmtShort2Y(a.due)}</span></div><div class="focus-actions"><button class="mini-btn" data-done="${a.id}">‚úî</button><button class="mini-btn" data-plus1="${a.id}">+1d</button><button class="mini-btn" data-edit="${a.id}">‚úé</button><button class="mini-btn" data-ics="${a.id}">üìÖ</button></div>`; ul.appendChild(li); li.querySelector(`[data-done="${a.id}"]`).addEventListener('click',()=>{ a.status='Completado'; save(); renderAll(); }); li.querySelector(`[data-plus1="${a.id}"]`).addEventListener('click',()=>{ if(!a.due) return; const d=new Date(a.due+'T00:00:00'); d.setDate(d.getDate()+1); a.due=d.toISOString().slice(0,10); save(); renderAll(); }); li.querySelector(`[data-edit="${a.id}"]`).addEventListener('click',()=>openAssignModal(a)); li.querySelector(`[data-ics="${a.id}"]`).addEventListener('click',()=>downloadICS(a)); }); };
  fill('#listOverdue', overdue); fill('#listToday', today); fill('#listWeek', soon);
}

// ===== Charts (top) =====
let pieChart, barChart;
function renderCharts(){
  const statuses=["No iniciado","En progreso","Entregado","Calificado","Completado"];
  const counts=statuses.map(s=>state.assignments.filter(a=>a.status===s).length);
  if(pieChart) pieChart.destroy(); pieChart=new Chart($('#pieStatus'),{type:'pie',data:{labels:statuses,datasets:[{data:counts,backgroundColor:statuses.map(s=>statusPinks[s])}]},options:{plugins:{legend:{position:'bottom'}},maintainAspectRatio:false}});
  const bins=Array.from({length:10},(_,i)=>i+1), binCounts=new Array(10).fill(0);
  state.assignments.forEach(a=>{ const raw=(a.grade||'').toString().replace(',', '.').trim(); const v=parseFloat(raw); if(!isNaN(v)){ const r=Math.round(v); if(r>=1 && r<=10) binCounts[r-1]++; }});
  if(barChart) barChart.destroy(); barChart=new Chart($('#barGrades'),{type:'bar',data:{labels:bins.map(String),datasets:[{label:'Cantidad',data:binCounts,backgroundColor:pinks10,borderColor:pinks10,borderWidth:1,borderRadius:6}]},options:{maintainAspectRatio:false,scales:{y:{beginAtZero:true,precision:0}},plugins:{legend:{display:false}}}});
}

function renderMetrics(){ $('#totalCount').textContent=state.assignments.length; $('#doneCount').textContent=state.assignments.filter(a=>a.status==='Completado').length; }

// ===== Modal: Task (with subtasks, tags, recurrence, weight) =====
function openAssignModal(item=null){
  const isEdit=!!item;
  const data=item || { id:uid(), title:'', course:state.courses[0]||'', status:'No iniciado', due:'', priority:'Media', type:DEFAULT_TYPES[0], est:'', notes:'', grade:'', subs:[], tags:[], recur:{type:'none',x:7}, weight:0, createdAt:Date.now() };
  if(!data.subs) data.subs=[]; if(!data.tags) data.tags=[]; if(!data.recur) data.recur={type:'none',x:7}; if(!data.createdAt) data.createdAt=Date.now();
  const courseOpts=state.courses.map(c=>`<option ${c===data.course?'selected':''}>${esc(c)}</option>`).join('');
  const statusOpts=DEFAULT_STATUS.map(s=>`<option ${s===data.status?'selected':''}>${s}</option>`).join('');
  const prioOpts=DEFAULT_PRIOS.map(s=>`<option ${s===data.priority?'selected':''}>${s}</option>`).join('');
  const typeOpts=DEFAULT_TYPES.map(s=>`<option ${s===data.type?'selected':''}>${s}</option>`).join('');
  const tagStr=data.tags.join(' ');
  const goal=state.goals[data.course]||'';

  $('#modalContent').innerHTML=`
    <div class='form'>
      <h3>${isEdit?'Editar tarea':'Nueva tarea'}</h3>
      <div><label>T√≠tulo</label><input id='a_title' class='input' value='${esc(data.title)}' placeholder='Ej: Ensayo de 5 p√°ginas'/></div>
      <div class='grid-3'>
        <div><label>Curso</label><select id='a_course' class='input'>${courseOpts}</select></div>
        <div><label>Estado</label><select id='a_status' class='input'>${statusOpts}</select></div>
        <div><label>Fecha l√≠mite</label><input id='a_due' type='date' class='input' value='${data.due||''}'/></div>
      </div>
      <div class='grid-3'>
        <div><label>Prioridad</label><select id='a_prio' class='input'>${prioOpts}</select></div>
        <div><label>Tipo</label><select id='a_type' class='input'>${typeOpts}</select></div>
        <div><label>Tiempo estimado</label><input id='a_est' class='input' value='${esc(data.est||'')}' placeholder='3h 30m o 210'/></div>
      </div>
      <div class='grid-3'>
        <div><label>Peso (%)</label><input id='a_weight' type='number' min='0' max='100' class='input' value='${data.weight||0}'/></div>
        <div><label>Calificaci√≥n (1‚Äì10)</label><input id='a_grade' class='input' value='${esc(data.grade||'')}' placeholder='8.5'/></div>
        <div><label>Etiquetas</label><input id='a_tags' class='input' list='taglist' value='${esc(tagStr)}' placeholder='#lectura #lab'/></div>
      </div>
      <div class='grid-3'>
        <div><label>Recurrencia</label>
          <select id='a_recur' class='input'>
            <option value='none' ${data.recur.type==='none'?'selected':''}>Sin repetir</option>
            <option value='weekly' ${data.recur.type==='weekly'?'selected':''}>Semanal</option>
            <option value='monthly' ${data.recur.type==='monthly'?'selected':''}>Mensual</option>
            <option value='xdays' ${data.recur.type==='xdays'?'selected':''}>Cada X d√≠as</option>
          </select>
        </div>
        <div><label>Si X d√≠as</label><input id='a_recur_x' type='number' class='input' value='${data.recur.x||7}'/></div>
        <div><label>Notas</label><input id='a_notes' class='input' value='${esc(data.notes||'')}'/></div>
      </div>

      <div><strong>Subtareas</strong><div id='subList' class='sublist'></div>
        <div class='subrow'><input id='subText' type='text' placeholder='Nueva subtarea‚Ä¶'/><button id='subAdd' class='mini-btn' type='button'>A√±adir</button><span></span></div>
      </div>

      <div id='goalBox' style='font-size:.9rem;color:#6d5f7a'></div>
    </div>
    <div class='actions'>
      <button value='cancel' class='btn btn-ghost'>Cancelar</button>
      <button id='a_save' class='btn'>${isEdit?'Guardar':'Crear'}</button>
    </div>`;

  const renderSubs=()=>{ const cont=$('#subList'); cont.innerHTML=''; data.subs.forEach(s=>{ const row=document.createElement('div'); row.className='subrow'; row.innerHTML=`<input type='checkbox' ${s.done?'checked':''} data-toggle='${s.id}'><input type='text' value='${esc(s.text)}' data-text='${s.id}'><button class='mini-btn' data-del='${s.id}' type='button'>Eliminar</button>`; cont.appendChild(row); row.querySelector(`[data-toggle='${s.id}']`).addEventListener('change',(e)=>{ s.done=e.target.checked; save(); }); row.querySelector(`[data-text='${s.id}']`).addEventListener('input',(e)=>{ s.text=e.target.value; }); row.querySelector(`[data-del='${s.id}']`).addEventListener('click',()=>{ data.subs=data.subs.filter(x=>x.id!==s.id); renderSubs(); }); }); };
  renderSubs();
  $('#subAdd').addEventListener('click',()=>{ const v=$('#subText').value.trim(); if(!v) return; data.subs.push({id:uid(), text:v, done:false}); $('#subText').value=''; renderSubs(); });

  const updateGoalBox=()=>{ const g=parseFloat(state.goals[$('#a_course').value]||NaN); const graded=state.assignments.filter(t=>t.course===$('#a_course').value && t.grade).concat(isEdit && data.grade? [data]:[]);
    let used=0, sum=0; graded.forEach(t=>{ const w=Number(t.weight||0); const gr=Number(t.grade||0); used += w; sum += w*gr; }); const rem=clamp(100-used,0,100); let msg=''; if(!isNaN(g) && rem>0){ const need=(g*100 - sum)/rem; const needClamped=clamp(need,0,10).toFixed(2); msg = `Objetivo curso: <b>${g.toFixed(1)}</b>. Con ${rem}% pendiente, necesitas promedio <b>${needClamped}</b> en el resto.`; }
    $('#goalBox').innerHTML = msg; };
  updateGoalBox();
  $('#a_course').addEventListener('change', updateGoalBox);

  $('#a_save').addEventListener('click',(e)=>{ e.preventDefault(); data.title=$('#a_title').value.trim(); data.course=$('#a_course').value; data.status=$('#a_status').value; data.due=$('#a_due').value||''; data.priority=$('#a_prio').value; data.type=$('#a_type').value; data.est=$('#a_est').value.trim(); data.notes=$('#a_notes').value.trim(); data.grade=$('#a_grade').value.trim(); data.tags=$('#a_tags').value.trim().split(/\s+/).filter(Boolean).map(t=>t.replace(/^#/,'')); data.weight=Number($('#a_weight').value||0); data.recur={ type:$('#a_recur').value, x:Number($('#a_recur_x').value||7) };
    // actualizar cat√°logo de tags
    data.tags.forEach(t=>{ if(!state.tags.includes(t)) state.tags.push(t); });
    if(!data.title) return alert('Escribe un t√≠tulo.');
    if(isEdit){ const i=state.assignments.findIndex(x=>x.id===data.id); state.assignments[i]=data; } else { state.assignments.push(data); }
    save(); $('#modal').close(); renderAll();
  });
  $('#modal').showModal();
}

// ===== Timer (Pomodoro b√°sico) =====
function openTimerModal(a){
  const running=state.timers[a.id] && state.timers[a.id].running; const elapsed=timerElapsed(a.id);
  $('#modalContent').innerHTML=`<div class='form'><h3>Temporizador ‚Äî ${esc(a.title)}</h3>
    <div class='grid-3'>
      <button class='btn' id='t25'>Pomodoro 25'</button>
      <button class='btn btn-ghost' id='t50'>Sesi√≥n 50'</button>
      <button class='btn btn-ghost' id='tStop'>Detener</button>
    </div>
    <div><strong>Transcurrido:</strong> <span id='elapsed'>${formatMins(elapsed)}</span></div>
  </div>
  <div class='actions'><button value='cancel' class='btn btn-ghost'>Cerrar</button></div>`;
  $('#t25').addEventListener('click',()=>startTimer(a.id,25));
  $('#t50').addEventListener('click',()=>startTimer(a.id,50));
  $('#tStop').addEventListener('click',()=>stopTimer(a.id));
  $('#modal').showModal();
}
function startTimer(id,mins){ state.timers[id]={running:true, start:Date.now(), target:Date.now()+mins*60000, acc: (state.timers[id]?.acc||0)}; save(); tickTimer(id); }
function stopTimer(id){ if(state.timers[id]){ const e=timerElapsed(id); state.timers[id]={running:false,start:0,target:0,acc:e}; save(); renderAll(); }
function timerElapsed(id){ const t=state.timers[id]; if(!t) return 0; const base=t.acc||0; if(t.running){ return base + Math.floor((Date.now()-t.start)/60000); } return base; }
function tickTimer(id){ const int=setInterval(()=>{ if(!state.timers[id]||!state.timers[id].running){ clearInterval(int); return; } const m=timerElapsed(id); const el=$('#elapsed'); if(el) el.textContent=formatMins(m); },1000); }
function formatMins(m){ return `${m|0} min`; }

// ===== Quick Add =====
function quickAddFromInput(){
  const v=$('#quickAdd').value.trim(); if(!v) return; // "Curso ¬∑ T√≠tulo ¬∑ dd/mm [#tag] [3h]"
  const parts=v.split('¬∑').map(s=>s.trim()); if(parts.length<2){ alert('Usa: Curso ¬∑ T√≠tulo ¬∑ dd/mm [#tag] [3h]'); return; }
  const course=parts[0]; const rest=parts.slice(1).join(' ¬∑ ');
  const mDate=rest.match(/(\b\d{1,2})\/(\d{1,2})(?:\/(\d{2}))?/); let due=''; if(mDate){ const dd=String(mDate[1]).padStart(2,'0'); const mm=String(mDate[2]).padStart(2,'0'); const yy=mDate[3] ? mDate[3] : new Date().toLocaleDateString('es',{year:'2-digit'}); const full=`20${yy}`; due=`${full}-${mm}-${dd}`; }
  const tags=[...(rest.match(/#\w+/g)||[])].map(t=>t.slice(1)); const estMatch=rest.match(/(\d+\s*h(?:\s*\d+\s*m)?|\d+\s*m|\b\d+\b)(?!\w)/); const est=estMatch?estMatch[1]:''; const title=rest.replace(mDate?.[0]||'','').replace(/#\w+/g,'').replace(est,'').replace(/\s+/g,' ').trim();
  const obj={ id:uid(), title, course, status:'No iniciado', due, priority:'Media', type:'Tarea', est, notes:'', grade:'', subs:[], tags, recur:{type:'none',x:7}, weight:0, createdAt:Date.now() };
  tags.forEach(t=>{ if(!state.tags.includes(t)) state.tags.push(t); }); if(!state.courses.includes(course)) state.courses.push(course);
  state.assignments.push(obj); save(); $('#quickAdd').value=''; renderAll();
}

function renderTagSuggestions(){ const dl=$('#taglist'); dl.innerHTML=''; state.tags.forEach(t=>{ const o=document.createElement('option'); o.value='#'+t; dl.appendChild(o); }); }

// ===== Bulk actions =====
function bulkICS(){ const sel=state.assignments.filter(a=>a._checked); if(!sel.length) return alert('Selecciona tareas.'); downloadICS(null, sel); }
function bulkDone(){ const sel=state.assignments.filter(a=>a._checked); sel.forEach(a=>a.status='Completado'); save(); renderAll(); }

// ===== ICS =====
function downloadICS(a=null, list=null){ const items=list||[a]; const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Assignment Tracker//ES']; items.forEach(t=>{ if(!t.due) return; const ymd=t.due.replaceAll('-',''); const dtEnd=(()=>{ const d=new Date(t.due+'T00:00:00'); d.setDate(d.getDate()+1); return d.toISOString().slice(0,10).replaceAll('-',''); })(); const title=`Entrega: ${t.title}`; const desc=`Curso: ${t.course||'‚Äî'}\nEstado: ${t.status}\nPrioridad: ${t.priority}\nNotas: ${(t.notes||'').replace(/\n/g,' ')}`; lines.push('BEGIN:VEVENT',`UID:${t.id}@assignment-tracker`,`SUMMARY:${title.replace(/([,;])/g,'\\$1')}`,`DTSTART;VALUE=DATE:${ymd}`,`DTEND;VALUE=DATE:${dtEnd}`,`DESCRIPTION:${desc.replace(/([,;])/g,'\\$1')}`,`CATEGORIES:${(t.course||'Tarea').replace(/([,;])/g,'\\$1')}`,'END:VEVENT'); }); lines.push('END:VCALENDAR'); const blob=new Blob([lines.join('\r\n')],{type:'text/calendar'}); const url=URL.createObjectURL(blob); const aTag=document.createElement('a'); aTag.href=url; aTag.download=list?'tareas_seleccionadas.ics':`tarea_${(a?.title||'evento').replace(/\s+/g,'_')}.ics`; document.body.appendChild(aTag); aTag.click(); aTag.remove(); URL.revokeObjectURL(url); }

// ===== Kanban =====
function renderKanban(){ const cols=["No iniciado","En progreso","Entregado","Calificado","Completado"]; const wrap=$('#kanban'); wrap.innerHTML=''; cols.forEach(st=>{ const col=document.createElement('div'); col.className='col'; col.innerHTML=`<h4>${st}</h4><div class='klist' data-col='${st}'></div>`; wrap.appendChild(col); });
  state.assignments.forEach(a=>{ const div=document.createElement('div'); div.className='cardk'; div.draggable=true; div.dataset.id=a.id; div.innerHTML=`<div class='title'>${esc(a.title)}</div><div class='meta'>${esc(a.course||'‚Äî')} ¬∑ vence ${fmtShort2Y(a.due)}</div>`; const col=$(`.klist[data-col='${a.status}']`) || $('.klist'); col.appendChild(div); div.addEventListener('dragstart',(e)=>{ e.dataTransfer.setData('text/plain', a.id); }); });
  $$('.klist').forEach(list=>{ list.addEventListener('dragover',(e)=>{ e.preventDefault(); list.style.background='#f8f3f7'; }); list.addEventListener('dragleave',()=>{ list.style.background=''; }); list.addEventListener('drop',(e)=>{ e.preventDefault(); list.style.background=''; const id=e.dataTransfer.getData('text/plain'); const t=findById(id); if(t){ t.status=list.dataset.col; save(); renderAll(); renderKanban(); } }); });
}

// ===== Analytics =====
let chActivity, chHours;
function renderAnalytics(){
  // Created vs Completed per ISO week (last 10 weeks)
  const weeks=Array.from({length:10},(_,i)=>i).map(x=>weekKey(Date.now()- (9-x)*7*86400000));
  const created=weeks.map(w=>state.assignments.filter(a=>weekKey(a.createdAt||Date.now())===w).length);
  const completed=weeks.map(w=>state.assignments.filter(a=>a.completedAt && weekKey(a.completedAt)===w).length);
  if(chActivity) chActivity.destroy(); chActivity=new Chart($('#chActivity'),{type:'bar',data:{labels:weeks,datasets:[{label:'Creadas',data:created},{label:'Completadas',data:completed}]},options:{plugins:{legend:{position:'bottom'}},maintainAspectRatio:false,scales:{y:{beginAtZero:true,precision:0}}});

  // Hours by course (last 7d) from timers.acc
  const byCourse={}; Object.entries(state.timers).forEach(([id,t])=>{ const a=findById(id); if(!a) return; const m=timerElapsed(id); const c=a.course||'General'; byCourse[c]=(byCourse[c]||0)+m; });
  const labels=Object.keys(byCourse), data=labels.map(k=>byCourse[k]);
  if(chHours) chHours.destroy(); chHours=new Chart($('#chHours'),{type:'bar',data:{labels,datasets:[{label:'Minutos',data}]},options:{plugins:{legend:{display:false}},maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});

  // Heat next 14 days
  const heat=$('#heat'); heat.innerHTML=''; const counts=new Array(14).fill(0); const now=new Date(); now.setHours(0,0,0,0);
  state.assignments.forEach(a=>{ if(!a.due) return; const d=new Date(a.due+'T00:00:00'); const diff=Math.round((d-now)/86400000); if(diff>=0 && diff<14) counts[diff]++; });
  counts.forEach(n=>{ const cell=document.createElement('div'); const light=95 - Math.min(n,6)*10; cell.style.background=`hsl(340,60%,${light}%)`; cell.title=`${n} tareas`; heat.appendChild(cell); });
}
function weekKey(ts){ const d=new Date(ts); const onejan=new Date(d.getFullYear(),0,1); const day=Math.floor((d - onejan)/86400000); const week=Math.ceil((day + onejan.getDay()+1)/7); return `${String(d.getFullYear()).slice(-2)}-W${String(week).padStart(2,'0')}`; }

// ===== Course Manager with Goal =====
function openCourseManager(){
  const list=state.courses.map((c,i)=>`<div class='grid-3' style='grid-template-columns:1fr 120px auto;align-items:center'><input class='input course-input' data-i='${i}' value='${esc(c)}'/><input class='input goal-input' data-i='${i}' type='number' step='0.1' placeholder='Objetivo nota' value='${state.goals[c]||''}'/><button class='btn btn-ghost' data-del='${i}' style='color:#c026d3'>Eliminar</button></div>`).join('');
  $('#modalContent').innerHTML=`<div class='form'><h3>Cursos</h3><div id='courseList'>${list||'<small>No hay cursos</small>'}</div><div class='grid-3' style='grid-template-columns:1fr auto auto;align-items:center'><input id='newCourse' class='input' placeholder='Nuevo curso'/><button id='addCourse' class='btn'>A√±adir</button><button value='cancel' class='btn btn-ghost' onclick="document.getElementById('modal').close()">Cerrar</button></div></div><div class='actions'><button id='saveCourses' class='btn'>Guardar cambios</button></div>`;
  $('#addCourse').addEventListener('click',()=>{ const v=$('#newCourse').value.trim(); if(!v) return; state.courses.push(v); save(); $('#modal').close(); openCourseManager(); });
  $$('#courseList [data-del]').forEach(btn=>btn.addEventListener('click',()=>{ const i=Number(btn.dataset.del); const name=state.courses[i]; state.assignments.forEach(a=>{ if(a.course===name) a.course=''; }); state.courses.splice(i,1); delete state.goals[name]; save(); $('#modal').close(); openCourseManager(); }));
  $('#saveCourses').addEventListener('click',()=>{ $$('.course-input').forEach(inp=>{ const i=Number(inp.dataset.i); const old=state.courses[i]; const val=inp.value.trim()||old; state.assignments.forEach(a=>{ if(a.course===old) a.course=val; }); state.courses[i]=val; const gEl=$(`.goal-input[data-i='${i}']`); const g=parseFloat(gEl.value); if(!isNaN(g)) state.goals[val]=g; }); save(); $('#modal').close(); renderAll(); });
  $('#modal').showModal();
}

// ===== Recurrence handling on completion =====
function handleRecurrenceOnComplete(a){ if(!a.due) return; const r=a.recur||{type:'none'}; if(r.type==='none') return; const next=new Date(a.due+'T00:00:00'); if(r.type==='weekly') next.setDate(next.getDate()+7); else if(r.type==='monthly') next.setMonth(next.getMonth()+1); else if(r.type==='xdays') next.setDate(next.getDate()+ (r.x||7)); const copy={...a, id:uid(), status:'No iniciado', due:next.toISOString().slice(0,10), createdAt:Date.now(), completedAt:null}; state.assignments.push(copy); }

// Monkey-patch when status changes to completed via checkbox or action
const _origSave=save; save=()=>{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); };
// Intercept completion events in renderTable and focus panel we already set a.status='Completado'; we add completedAt and recurrence
const _setStatus=(a,newStatus)=>{ if(a.status!==newStatus){ if(newStatus==='Completado'){ a.completedAt=Date.now(); handleRecurrenceOnComplete(a); } a.status=newStatus; save(); }};

// ===== JSON/CSV Import Export =====
function exportJSON(){ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='assignment_tracker_pro.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function importJSON(e){ const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result); (data.assignments||[]).forEach(t=>{ if(!t.subs) t.subs=[]; if(!t.tags) t.tags=[]; }); state={...state, ...data}; save(); location.reload(); }catch(err){ alert('No se pudo importar: '+err.message); } }; reader.readAsText(file); }
function exportCSV(){ const cols=['title','course','status','due','priority','type','est','notes','grade','tags','weight']; const rows=state.assignments.map(a=>[a.title,a.course,a.status,a.due,a.priority,a.type,a.est,(a.notes||'').replace(/\n/g,' '),a.grade,(a.tags||[]).map(t=>'#'+t).join(' '),a.weight].map(v=>`"${String(v||'').replace(/"/g,'\"')}"`).join(',')); const csv=[cols.join(','),...rows].join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='assignment_tracker.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function importCSV(e){ const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>{ const text=reader.result; const lines=text.trim().split(/\r?\n/); const header=lines.shift().split(',').map(s=>s.replace(/^\"|\"$/g,'')); lines.forEach(line=>{ const cells=parseCSV(line); const obj={}; header.forEach((h,i)=>obj[h]=cells[i]?cells[i].replace(/^\"|\"$/g,''):'' ); const a={ id:uid(), title:obj.title, course:obj.course, status:obj.status||'No iniciado', due:obj.due||'', priority:obj.priority||'Media', type:obj.type||'Tarea', est:obj.est||'', notes:obj.notes||'', grade:obj.grade||'', tags:(obj.tags||'').split(/\s+/).filter(Boolean).map(t=>t.replace(/^#/,'')), subs:[], weight:Number(obj.weight||0), recur:{type:'none',x:7}, createdAt:Date.now() }; state.assignments.push(a); a.tags.forEach(t=>{ if(!state.tags.includes(t)) state.tags.push(t); }); if(a.course && !state.courses.includes(a.course)) state.courses.push(a.course); }); save(); renderAll(); }; reader.readAsText(file); }
function parseCSV(line){ const out=[]; let cur='', inq=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ if(inq && line[i+1]==='"'){ cur+='"'; i++; } else inq=!inq; } else if(ch===',' && !inq){ out.push(cur); cur=''; } else cur+=ch; } out.push(cur); return out; }

// ===== Plan semanal =====
let planCache=[];
function generatePlan(){
  const daysInput=$('#planDays').value || 'Lun,Mar,Mi√©,Jue,Vie';
  const hoursInput=$('#planHours').value || '18:00-20:00';
  const blockMins=Number($('#planBlock').value||90);
  const dayMap={Lun:1,Mar:2,Mi√©:3,Mie:3,Jue:4,Vie:5,S√°b:6,Sab:6,Dom:0};
  const days=daysInput.split(',').map(s=>s.trim()).map(d=>dayMap[d]).filter(v=>v!==undefined);
  const [h1,h2]=hoursInput.split('-');
  const toMin=t=>{const [H,M]=t.split(':').map(Number); return H*60+M}; const start=toMin(h1), end=toMin(h2);
  const slots=days.map(dow=>({dow,start,end}));
  // Gather tasks due in 14 days with positive est
  const tasks=state.assignments.filter(a=>a.status!=='Completado' && a.due && daysLeft(a.due)>=0 && daysLeft(a.due)<=14).map(a=>({a, mins:Math.max(30, parseEst(a.est)||60)}));
  // Build calendar from next Monday to two weeks
  const now=new Date(); now.setHours(0,0,0,0);
  const plan=[];
  for(let day=0; day<14; day++){
    const d=new Date(now); d.setDate(d.getDate()+day);
    const dow=d.getDay();
    const sl=slots.find(s=>s.dow===dow);
    if(!sl) continue;
    let cur=sl.start; while(cur+blockMins<=sl.end){
      const task=tasks.sort((x,y)=> new Date(x.a.due)-new Date(y.a.due))[0];
      if(!task) break; plan.push({title:task.a.title, course:task.a.course, start:minsToDate(d,cur), end:minsToDate(d,cur+blockMins)});
      task.mins-=blockMins; if(task.mins<=0) tasks.shift();
      cur+=blockMins;
    }
  }
  planCache=plan; renderPlanList();
}
function minsToDate(d,mins){ const nd=new Date(d); nd.setHours(0,0,0,0); nd.setMinutes(mins); return nd; }
function renderPlanList(){ const cont=$('#planList'); cont.innerHTML=''; if(!planCache.length){ cont.textContent='No hay bloques generados a√∫n.'; return; } const ul=document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding='0'; planCache.forEach(ev=>{ const li=document.createElement('li'); li.className='focus-item'; const range=`${ev.start.toLocaleString('es',{weekday:'short', day:'2-digit', month:'2-digit'})} ¬∑ ${ev.start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}‚Äì${ev.end.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`; li.innerHTML=`<div class='focus-main'><span class='focus-title'>${esc(ev.title)}</span><span class='chip'>${esc(ev.course||'General')}</span><span class='chip'>${range}</span></div>`; ul.appendChild(li); }); cont.appendChild(ul); }
function downloadPlanICS(){ if(!planCache.length) return alert('Genera el plan primero.'); const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Assignment Tracker//Plan']; planCache.forEach((ev,i)=>{ const fmt=(dt)=>{ const y=dt.getFullYear(); const m=String(dt.getMonth()+1).padStart(2,'0'); const d=String(dt.getDate()).padStart(2,'0'); const H=String(dt.getHours()).padStart(2,'0'); const M=String(dt.getMinutes()).padStart(2,'0'); return `${y}${m}${d}T${H}${M}00`; }; lines.push('BEGIN:VEVENT',`UID:plan${i}@assignment-tracker`,`SUMMARY:${(ev.course?ev.course+': ':'')+ev.title}`.replace(/([,;])/g,'\\$1'),`DTSTART:${fmt(ev.start)}`,`DTEND:${fmt(ev.end)}`,'END:VEVENT'); }); lines.push('END:VCALENDAR'); const blob=new Blob([lines.join('\r\n')],{type:'text/calendar'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='plan_semana.ics'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

// ===== Helpers =====
function renderTagPills(){/* already inline */}

</script>
</body>
</html>
